name: Publish to GitHub Packages

on:
  # Trigger on push to main branch (for continuous publishing)
  push:
    branches: [ main, 001-multi-agent-toolkit ]
  # Trigger on release tags
  release:
    types: [ published ]
  # Allow manual dispatch
  workflow_dispatch:

env:
  CARGO_TERM_COLOR: always
  # Use GitHub Packages registry
  CARGO_REGISTRY: github

jobs:
  test:
    name: Test Suite
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y tmux git

      - name: Run unit tests
        run: cargo test --lib --bins --verbose

      - name: Run integration tests (must be sequential for tmux)
        run: |
          # Run tmux-dependent tests sequentially to avoid session conflicts
          cargo test --test init_workflow_test --verbose -- --test-threads=1
          cargo test --test session_management_test --verbose -- --test-threads=1

      - name: Run clippy
        run: cargo clippy -- -D warnings

      - name: Check formatting
        run: cargo fmt -- --check

  publish-github-packages:
    name: Publish to GitHub Packages
    needs: test
    runs-on: ubuntu-latest
    if: github.event_name != 'pull_request'
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Extract version
        id: version
        run: |
          # Extract version from Cargo.toml
          VERSION=$(grep '^version = ' Cargo.toml | head -1 | cut -d '"' -f 2)
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
          echo "Cargo version: $VERSION"

      - name: Configure Cargo for GitHub Packages
        run: |
          # Configure cargo to use GitHub Packages registry
          mkdir -p ~/.cargo
          cat > ~/.cargo/config.toml << 'EOF'
          [registry.github]
          index = "https://github.com/hotaq/Sprit-mutil.git/registry/index/"
          EOF

      - name: Login to GitHub Packages
        run: echo "${{ secrets.GITHUB_TOKEN }}" | cargo login --registry github

      - name: Publish to GitHub Packages
        env:
          CARGO_REGISTRY_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Publish with verbose output for debugging
          cargo publish --registry github --verbose

      - name: Verify package is available
        run: |
          # Wait a moment for the package to be available
          sleep 30
          # Try to install the package to verify it's available
          timeout 300 cargo install --registry github --debug sprite || echo "Package verification timed out, but this is normal for new packages"

  create-release-info:
    name: Create Release Information
    needs: publish-github-packages
    runs-on: ubuntu-latest
    if: github.event_name == 'release'
    steps:
      - uses: actions/checkout@v4

      - name: Extract version
        id: version
        run: |
          VERSION=$(grep '^version = ' Cargo.toml | head -1 | cut -d '"' -f 2)
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT

      - name: Comment on release
        uses: actions/github-script@v6
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `## ðŸ“¦ GitHub Packages Available

            Version ${{ steps.version.outputs.VERSION }} is now available on GitHub Packages!

            ### Installation
            \`\`\`bash
            # Method 1: Using cargo install with GitHub Packages
            cargo install --registry github --git https://github.com/hotaq/Sprit-mutil.git sprite

            # Method 2: Adding to Cargo.toml
            [dependencies]
            sprite = { version = "${{ steps.version.outputs.VERSION }}", registry = "github" }

            # Method 3: Direct download
            # Download from the Assets section below
            \`\`\`

            ### Package URL
            \`https://github.com/hotaq/Sprit-mutil/pkgs/container/sprite\`

            The package will be available within a few minutes after publication.`
            })